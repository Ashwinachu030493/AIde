name: CD Pipeline

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      environment:
        description: Deployment environment
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  build-and-publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Extract version from tag
      id: get_version
      run: |
        if [[ "$GITHUB_REF" =~ ^refs/tags/v(.*)$ ]]; then
          echo "VERSION=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
        else
          echo "VERSION=dev-${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
        fi
        
    - name: Build backend package
      run: |
        cd server
        python -m pip install --upgrade pip build
        python -m build
        
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Build VS Code extension
      working-directory: extension
      run: |
        npm ci
        npm run compile
        npm run package
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-artifacts-${{ steps.get_version.outputs.VERSION }}
        path: |
          server/dist/
          extension/*.vsix
        retention-days: 30
        
    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          server/dist/*.whl
          server/dist/*.tar.gz
          extension/*.vsix
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.aide.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-*
        path: ./artifacts
        
    - name: Deploy to staging server
      run: |
        echo "Deploying to staging environment..."
        echo "This would typically:"
        echo "  - Copy files to staging server"
        echo "  - Run database migrations"
        echo "  - Restart services"
        echo "  - Run smoke tests"
        
    - name: Run post-deployment tests
      run: |
        echo "Running smoke tests against staging..."
        # Add actual smoke test commands here
        
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-publish
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://aide.example.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-artifacts-*
        path: ./artifacts
        
    - name: Deploy to production server
      run: |
        echo "Deploying to production environment..."
        echo "This would typically:"
        echo "  - Copy files to production server"
        echo "  - Run database migrations"
        echo "  - Perform blue-green deployment"
        echo "  - Run comprehensive smoke tests"
        echo "  - Monitor for errors"
        
    - name: Run post-deployment tests
      run: |
        echo "Running production smoke tests..."
        # Add actual smoke test commands here
        
    - name: Notify deployment
      if: always()
      run: |
        echo "Deployment completed with status: ${{ job.status }}"
        # Add notification logic (Slack, email, etc.)
